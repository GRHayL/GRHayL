# GRHayL

---

[![Ubuntu-gcc](https://github.com/GRHayL/GRHayL/actions/workflows/github-actions-Ubuntu-gcc.yml/badge.svg)](https://github.com/GRHayL/GRHayL/actions/workflows/github-actions-Ubuntu-gcc.yml)
[![Ubuntu-intel](https://github.com/GRHayL/GRHayL/actions/workflows/github-actions-Ubuntu-intel.yml/badge.svg)](https://github.com/GRHayL/GRHayL/actions/workflows/github-actions-Ubuntu-intel.yml)
[![Ubuntu-clang](https://github.com/GRHayL/GRHayL/actions/workflows/github-actions-Ubuntu-clang.yml/badge.svg)](https://github.com/GRHayL/GRHayL/actions/workflows/github-actions-Ubuntu-clang.yml)
[![MacOS-gcc](https://github.com/GRHayL/GRHayL/actions/workflows/github-actions-MacOS-gcc.yml/badge.svg)](https://github.com/GRHayL/GRHayL/actions/workflows/github-actions-MacOS-gcc.yml)
[![MacOS-clang](https://github.com/GRHayL/GRHayL/actions/workflows/github-actions-MacOS-clang.yml/badge.svg)](https://github.com/GRHayL/GRHayL/actions/workflows/github-actions-MacOS-clang.yml)
[![codecov](https://codecov.io/gh/GRHayL/GRHayL/branch/main/graph/badge.svg)](https://codecov.io/gh/GRHayL/GRHayL)

The General Relativistic Hydrodynamic Library (GRHayL) is an infrastructure-agnostic
magnetohydrodynamics code library designed for modular development of GRMHD code.
The library is divided into independent modules, or "gems", which provide various
features needed for GRMHD simulations.

The core GRHayL "chalice" provides core connective tissue in the form of C structs
and very simple functions that act only on these structs. Adding onto GRHayL_Core are
several gems which provide specific features. These currently include Atmosphere, Con2Prim,
EOS, Flux_Source, Induction, Neutrinos, and Reconstruction. Each gem implements
infrastructure-agnostic functions for computing quantities for GRMHD simulations.

The Atmosphere gem provides functions for setting the primitive struct using a specfic
atmosphere prescription.

The Con2Prim gem provides functions to perform the conservative-to-primitive (con2prim)
variable recovery. The primary functions here are various con2prim methods, but we
also provide functions for computing the conservatives and Tmunu from the primitives,
enforce limits on the computed primitives, etc. All the C2P routines have the same
argument list, allowing for quick and easy substitution. The function
`ghl_con2prim_multi_method()` provides runtime switching between available methods,
as well as the option to choose backup routines in the case of failure.

The EOS gem provides many functions which are needed by other gems to compute quantities
(e.g. P_cold for hybrid EOS or table interpolation for tabulated EOS). The other gems depend
purely on the eos_parameters struct and function pointers defined in the ghl.h header.
The EOS gem provides a function to initialize these function pointers to point to the specific
implementation provided by GRHayL, but some or all can be changed to point to new user-made
functions. This allows for all the other gems to be entirely unaware of how these EOS quantities
are being computed.

The Flux_Source gem provides functions for computing the hydrodynamic right-hand sides. This includes
functions for the characteristic speeds (which are also needed for the induction equation right-hand
sides), the numerical fluxes, and the source terms.

The Induction gem provides functions for computing right-hand sides for A_i and \tilde{\Phi}. This is
split into three categories. First, there are the numerical fluxes for A_i (currently we provide a
function for the HLL flux). Then, we provide a set of interpolation functions in preparation for computing
the gauge term contributions to A_i and the RHS of \tilde{\Phi}. Finally, we provide a function to compute
\tilde{\Phi} RHS.

The Reconstruction gem provides functions for reconstructing quantities to cell faces. We have a variety
of reconstruction methods, and most functions have the same argument list.

The Unit_Tests directory contains the unit tests which are used by the Github Actions continuous
integration testing. The subdirectory "data_gen" contains the functions for generating the test data.
The actual test data is kept in the https://github.com/GRHayL/Test_Data repository. Tests with "ET_Legacy"
in the name only generate input data, as the output is generated from the GRHayLTestPatch branch of
IllinoisGRMHD in the Einstein Toolkit for validation with the old code. All the tests function by generating
output data and perturbed output data. The perturbed data is generated by perturbing the input data by

perturbed input = input X (1 + 1e-14).

This output serves as error bars for the functions, and the tests validate that the computed output falls
within this range.

The implementations directory contains specific implementations of GRHayL in infrastructures. In the
following section, we describe how to directly compile the library for linking. However, it can be
significantly easier in some infrastructures to directly compile the source code instead of linking
to an external library. We currently only provide and maintain an implementation for the Einstein Toolkit.
Other codes we maintain which use GRHayL are linking to the compiled library.

## Building and Installing `GRHayL`

`GRHayL` uses the [meson build system](https://mesonbuild.com). For the
convenience of users we package `GRHayL` with a `configure` script wrapper,
which is a `Python3` script that handles the `meson` configuration. The builds
happen out of the source tree, with all object files placed in the `build/`
directory (by default).

The standard back-end used by `meson` is `ninja`. To install them we recommend
using a virtual environment as that takes care of potential permission issues.
Here's an example of how to set it up:

```shell
$ python3 -m venv py3
$ source py3/bin/activate
(py3) $ pip install -U pip
(py3) $ pip install meson ninja
```

### Dependencies

Currently, `GRHayL` requires `HDF5` C bindings in order to compile. On Ubuntu,
you can install `HDF5` using

```shell
$ sudo apt-get install libhdf5-serial-dev
```

`GRHayL` is also actively tested on MacOS using the [Homebrew](https://brew.sh/)
package manager. To install `HDF5` on MacOS we thus recommend using

```shell
$ brew install hdf5
```

We have not tested `GRHayL` with [macports](https://www.macports.org/), although
we do not expect users to have issues when using it.

The `HDF5` dependency arises from the Tabulated Equation of State (EOS) gem, as
it currently only supports EOS tables in that format. We are working on adding
an option to compile `GRHayL` with Hybrid EOS support only, thus removing the
`HDF5` dependency for those who do not wish to use Tabulated EOSs. We are also
working supporting tables in the [CompOSE](https://compose.obspm.fr/table)
format, which would also remove the `HDF5` dependency for those who wish to use
these larger ASCII tables.

### System-wide Installation (default)

As an example, suppose you wish to install `GRHayL` on your system using
`gcc`. To do so, run the following commands:

```shell
$ CC=gcc ./configure
$ make
$ make install
```

### Local Installation

As an example, a local installation that uses the next-generation intel
compilers is achieved as follows:

```shell
$ CC=icx ./configure --prefix=<local_path>
$ make
$ make install
```

### Legacy Development Build System

`GRHayL` currently contains an "old" `Makefile` that is still used by its
developers, but is likely to be deprecated and/or removed in the
future. Although this `Makefile` does take *some* measures that allow `GRHayL`
to be compiled on a few different systems, it is *not* the recommended way to
compile the library. One cannot specify the installation (`./lib`) and build
(`./build`) paths when using this `Makefile`, and it also does not produce an
`include` directory alongside the `lib` directory. To use it, simply run

```shell
$ make
```

without running `./configure` first. When `./configure` is run, the `Makefile`
is replaced by a different one that makes use of the `meson` build system. To
restore the old `Makefile` and clean up all files produced by the `meson` build,
use

```shell
$ make realclean
```
